name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: |
          # Check all Python files
          ruff check . --ignore E501

      - name: Run ruff format check
        run: |
          # Check formatting (don't auto-fix)
          ruff format --check . || echo "Formatting issues found (non-blocking)"

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Install template dependencies
        run: |
          # Install each template's dependencies
          cd templates/template-fastapi-service && pip install -e ".[dev]" && cd ../..
          cd templates/template-data-pipeline && pip install -e ".[dev]" && cd ../..
          cd templates/template-eval-harness && pip install -e ".[dev]" && cd ../..
          cd examples/mini-example && pip install -e ".[dev]" && cd ../..

      - name: Run tests - FastAPI Template
        run: |
          cd templates/template-fastapi-service
          pytest tests/ -v --tb=short
          cd ../..

      - name: Run tests - Data Pipeline Template
        run: |
          cd templates/template-data-pipeline
          pytest tests/ -v --tb=short
          cd ../..

      - name: Run tests - Eval Harness Template
        run: |
          cd templates/template-eval-harness
          pytest tests/ -v --tb=short
          cd ../..

      - name: Run tests - Mini Example
        run: |
          cd examples/mini-example
          pytest tests/ -v --tb=short
          cd ../..

  path-engine:
    name: Path Engine
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify path engine scripts
        run: |
          # Check that path engine scripts are valid Python
          python -m py_compile .claude/path-engine/evaluate.py
          python -m py_compile .claude/path-engine/adapt.py
          python -m py_compile .claude/path-engine/report.py

      - name: Test path engine evaluate
        run: |
          # Run evaluate with --help (should not error)
          python .claude/path-engine/evaluate.py --help || true

  docs:
    name: Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation links
        run: |
          # Simple check for broken internal links in markdown
          echo "Checking for broken internal links..."

          # Find all .md files
          find . -name "*.md" -type f | while read file; do
            # Extract markdown links [text](link)
            grep -oE '\[([^\]]+)\]\(([^)]+)\)' "$file" 2>/dev/null | while read link; do
              # Extract the path part
              path=$(echo "$link" | sed -E 's/.*\(([^)]+)\)/\1/')

              # Skip external links and anchors
              if [[ "$path" == http* ]] || [[ "$path" == \#* ]] || [[ "$path" == mailto* ]]; then
                continue
              fi

              # For relative paths, check if file exists
              dir=$(dirname "$file")
              if [[ "$path" == /* ]]; then
                target=".$path"
              else
                target="$dir/$path"
              fi

              # Remove anchor from path
              target_file=$(echo "$target" | sed 's/#.*//')

              if [[ -n "$target_file" ]] && [[ ! -e "$target_file" ]]; then
                echo "Warning: Potentially broken link in $file: $path"
              fi
            done
          done

          echo "Documentation check complete."

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, path-engine, docs]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Path Engine: ${{ needs.path-engine.result }}"
          echo "Docs: ${{ needs.docs.result }}"

          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test.result }}" == "failure" ]] || \
             [[ "${{ needs.path-engine.result }}" == "failure" ]]; then
            echo "CI failed!"
            exit 1
          fi

          echo "All checks passed!"
